name: 'Next.js visual-regression ‚Üí PDF'
author: 'Cdaprod'
description: >
  Build a Next.js App-router project, crawl all internal pages, render them to a
  single PDF, and commit it into docs/visual-regression/ (keeping the newest N).

inputs:
  workdir:
    description: 'Sub-directory that contains the Next.js app'
    default: '.'
  build_cmd:
    description: 'Command to build the site'
    default: 'pnpm run build'
  start_cmd:
    description: 'Command that starts the production server'
    default: 'pnpm run start'
  port:
    description: 'Port the server listens on'
    default: '3000'
  keep:
    description: 'How many historical PDFs to keep'
    default: '5'
  pdf_dir:
    description: 'Folder (inside repo) to store PDFs'
    default: 'docs/visual-regression'
  depth:
    description: 'Crawler link depth (0 = only /)'
    default: '2'

runs:
  using: 'composite'
  steps:
    - name: ‚ú® Install Node & deps
      uses: pnpm/action-setup@v2
      with:
        version: '8'
    - run: |
        cd ${{ inputs.workdir }}
        pnpm install --frozen-lockfile
      shell: bash

    - name: üî® Build
      run: cd ${{ inputs.workdir }} && ${{ inputs.build_cmd }}
      shell: bash

    - name: üöÄ Start server
      run: |
        cd ${{ inputs.workdir }}
        ${{ inputs.start_cmd }} &
        npx wait-port ${{ inputs.port }}
      shell: bash

    - name: üì∏ Crawl & render PDF
      run: |
        node ${{ github.action_path }}/scripts/crawl2pdf.mjs \
             http://localhost:${{ inputs.port }} \
             ${{ inputs.depth }} \
             visreg.pdf
      shell: bash

    - name: üóÑÔ∏è Move & prune
      run: |
        set -e
        mkdir -p ${{ inputs.pdf_dir }}
        cp visreg.pdf ${{ inputs.pdf_dir }}/${{ github.sha }}.pdf
        cd ${{ inputs.pdf_dir }}
        ls -t *.pdf | tail -n +$((${{ inputs.keep }}+1)) | xargs -r git rm -f --
      shell: bash

    - name: ÔøΩ commit
      env:
        GH_TOKEN: ${{ github.token }}
      run: |
        git config user.name  'visreg-bot'
        git config user.email 'visreg-bot@users.noreply.github.com'
        git add ${{ inputs.pdf_dir }}
        if git diff --cached --quiet; then
          echo 'nothing to commit'
        else
          git commit -m "chore(visreg): update PDF for ${{ github.sha }}"
          git push "https://${GH_TOKEN}@github.com/${{ github.repository }}.git" HEAD:${{ github.ref_name }}
        fi
      shell: bash